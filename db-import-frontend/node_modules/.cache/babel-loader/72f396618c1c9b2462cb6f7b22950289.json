{"ast":null,"code":"\"use strict\";\n\nvar _regeneratorRuntime = require(\"/Users/aribraun/Desktop/db-import/db-import-frontend/node_modules/@babel/runtime/helpers/regeneratorRuntime.js\").default;\nvar _asyncToGenerator = require(\"/Users/aribraun/Desktop/db-import/db-import-frontend/node_modules/@babel/runtime/helpers/asyncToGenerator.js\").default;\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.sendInParallel = sendInParallel;\nexports.sendMessage = sendMessage;\nvar _dgram = _interopRequireDefault(require(\"dgram\"));\nvar _net = _interopRequireDefault(require(\"net\"));\nvar punycode = _interopRequireWildcard(require(\"punycode\"));\nvar _abortError = _interopRequireDefault(require(\"./errors/abort-error\"));\nfunction _getRequireWildcardCache(nodeInterop) {\n  if (typeof WeakMap !== \"function\") return null;\n  var cacheBabelInterop = new WeakMap();\n  var cacheNodeInterop = new WeakMap();\n  return (_getRequireWildcardCache = function _getRequireWildcardCache(nodeInterop) {\n    return nodeInterop ? cacheNodeInterop : cacheBabelInterop;\n  })(nodeInterop);\n}\nfunction _interopRequireWildcard(obj, nodeInterop) {\n  if (!nodeInterop && obj && obj.__esModule) {\n    return obj;\n  }\n  if (obj === null || typeof obj !== \"object\" && typeof obj !== \"function\") {\n    return {\n      default: obj\n    };\n  }\n  var cache = _getRequireWildcardCache(nodeInterop);\n  if (cache && cache.has(obj)) {\n    return cache.get(obj);\n  }\n  var newObj = {};\n  var hasPropertyDescriptor = Object.defineProperty && Object.getOwnPropertyDescriptor;\n  for (var key in obj) {\n    if (key !== \"default\" && Object.prototype.hasOwnProperty.call(obj, key)) {\n      var desc = hasPropertyDescriptor ? Object.getOwnPropertyDescriptor(obj, key) : null;\n      if (desc && (desc.get || desc.set)) {\n        Object.defineProperty(newObj, key, desc);\n      } else {\n        newObj[key] = obj[key];\n      }\n    }\n  }\n  newObj.default = obj;\n  if (cache) {\n    cache.set(obj, newObj);\n  }\n  return newObj;\n}\nfunction _interopRequireDefault(obj) {\n  return obj && obj.__esModule ? obj : {\n    default: obj\n  };\n}\nfunction sendInParallel(_x, _x2, _x3, _x4) {\n  return _sendInParallel.apply(this, arguments);\n}\nfunction _sendInParallel() {\n  _sendInParallel = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime().mark(function _callee(addresses, port, request, signal) {\n    return _regeneratorRuntime().wrap(function _callee$(_context) {\n      while (1) switch (_context.prev = _context.next) {\n        case 0:\n          if (!signal.aborted) {\n            _context.next = 2;\n            break;\n          }\n          throw new _abortError.default();\n        case 2:\n          _context.next = 4;\n          return new Promise(function (resolve, reject) {\n            var sockets = [];\n            var errorCount = 0;\n            var onError = function onError(err) {\n              errorCount++;\n              if (errorCount === addresses.length) {\n                signal.removeEventListener('abort', onAbort);\n                clearSockets();\n                reject(err);\n              }\n            };\n            var onMessage = function onMessage(message) {\n              signal.removeEventListener('abort', onAbort);\n              clearSockets();\n              resolve(message);\n            };\n            var onAbort = function onAbort() {\n              clearSockets();\n              reject(new _abortError.default());\n            };\n            var clearSockets = function clearSockets() {\n              for (var _i = 0, _sockets = sockets; _i < _sockets.length; _i++) {\n                var socket = _sockets[_i];\n                socket.removeListener('error', onError);\n                socket.removeListener('message', onMessage);\n                socket.close();\n              }\n            };\n            signal.addEventListener('abort', onAbort, {\n              once: true\n            });\n            for (var j = 0; j < addresses.length; j++) {\n              var udpType = addresses[j].family === 6 ? 'udp6' : 'udp4';\n              var socket = _dgram.default.createSocket(udpType);\n              sockets.push(socket);\n              socket.on('error', onError);\n              socket.on('message', onMessage);\n              socket.send(request, 0, request.length, port, addresses[j].address);\n            }\n          });\n        case 4:\n          return _context.abrupt(\"return\", _context.sent);\n        case 5:\n        case \"end\":\n          return _context.stop();\n      }\n    }, _callee);\n  }));\n  return _sendInParallel.apply(this, arguments);\n}\nfunction sendMessage(_x5, _x6, _x7, _x8, _x9) {\n  return _sendMessage.apply(this, arguments);\n}\nfunction _sendMessage() {\n  _sendMessage = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime().mark(function _callee2(host, port, lookup, signal, request) {\n    var addresses;\n    return _regeneratorRuntime().wrap(function _callee2$(_context2) {\n      while (1) switch (_context2.prev = _context2.next) {\n        case 0:\n          if (!signal.aborted) {\n            _context2.next = 2;\n            break;\n          }\n          throw new _abortError.default();\n        case 2:\n          if (!_net.default.isIP(host)) {\n            _context2.next = 6;\n            break;\n          }\n          addresses = [{\n            address: host,\n            family: _net.default.isIPv6(host) ? 6 : 4\n          }];\n          _context2.next = 9;\n          break;\n        case 6:\n          _context2.next = 8;\n          return new Promise(function (resolve, reject) {\n            var onAbort = function onAbort() {\n              reject(new _abortError.default());\n            };\n            signal.addEventListener('abort', onAbort);\n            lookup(punycode.toASCII(host), {\n              all: true\n            }, function (err, addresses) {\n              signal.removeEventListener('abort', onAbort);\n              err ? reject(err) : resolve(addresses);\n            });\n          });\n        case 8:\n          addresses = _context2.sent;\n        case 9:\n          _context2.next = 11;\n          return sendInParallel(addresses, port, request, signal);\n        case 11:\n          return _context2.abrupt(\"return\", _context2.sent);\n        case 12:\n        case \"end\":\n          return _context2.stop();\n      }\n    }, _callee2);\n  }));\n  return _sendMessage.apply(this, arguments);\n}","map":{"version":3,"names":["_dgram","_interopRequireDefault","require","_net","punycode","_interopRequireWildcard","_abortError","sendInParallel","_x","_x2","_x3","_x4","_sendInParallel","apply","arguments","_asyncToGenerator","_regeneratorRuntime","mark","_callee","addresses","port","request","signal","wrap","_callee$","_context","prev","next","aborted","default","Promise","resolve","reject","sockets","errorCount","onError","err","length","removeEventListener","onAbort","clearSockets","onMessage","message","_i","_sockets","socket","removeListener","close","addEventListener","once","j","udpType","family","createSocket","push","on","send","address","abrupt","sent","stop","sendMessage","_x5","_x6","_x7","_x8","_x9","_sendMessage","_callee2","host","lookup","_callee2$","_context2","isIP","isIPv6","toASCII","all"],"sources":["../src/sender.ts"],"sourcesContent":["import dgram from 'dgram';\nimport dns from 'dns';\nimport net from 'net';\nimport * as punycode from 'punycode';\nimport { AbortSignal } from 'node-abort-controller';\n\nimport AbortError from './errors/abort-error';\n\ntype LookupFunction = (hostname: string, options: dns.LookupAllOptions, callback: (err: NodeJS.ErrnoException | null, addresses: dns.LookupAddress[]) => void) => void;\n\nexport async function sendInParallel(addresses: dns.LookupAddress[], port: number, request: Buffer, signal: AbortSignal) {\n  if (signal.aborted) {\n    throw new AbortError();\n  }\n\n  return await new Promise<Buffer>((resolve, reject) => {\n    const sockets: dgram.Socket[] = [];\n\n    let errorCount = 0;\n\n    const onError = (err: Error) => {\n      errorCount++;\n\n      if (errorCount === addresses.length) {\n        signal.removeEventListener('abort', onAbort);\n        clearSockets();\n\n        reject(err);\n      }\n    };\n\n    const onMessage = (message: Buffer) => {\n      signal.removeEventListener('abort', onAbort);\n      clearSockets();\n\n      resolve(message);\n    };\n\n    const onAbort = () => {\n      clearSockets();\n\n      reject(new AbortError());\n    };\n\n    const clearSockets = () => {\n      for (const socket of sockets) {\n        socket.removeListener('error', onError);\n        socket.removeListener('message', onMessage);\n        socket.close();\n      }\n    };\n\n    signal.addEventListener('abort', onAbort, { once: true });\n\n    for (let j = 0; j < addresses.length; j++) {\n      const udpType = addresses[j].family === 6 ? 'udp6' : 'udp4';\n\n      const socket = dgram.createSocket(udpType);\n      sockets.push(socket);\n      socket.on('error', onError);\n      socket.on('message', onMessage);\n      socket.send(request, 0, request.length, port, addresses[j].address);\n    }\n  });\n}\n\nexport async function sendMessage(host: string, port: number, lookup: LookupFunction, signal: AbortSignal, request: Buffer) {\n  if (signal.aborted) {\n    throw new AbortError();\n  }\n\n  let addresses: dns.LookupAddress[];\n\n  if (net.isIP(host)) {\n    addresses = [\n      { address: host, family: net.isIPv6(host) ? 6 : 4 }\n    ];\n  } else {\n    addresses = await new Promise<dns.LookupAddress[]>((resolve, reject) => {\n      const onAbort = () => {\n        reject(new AbortError());\n      };\n\n      signal.addEventListener('abort', onAbort);\n\n      lookup(punycode.toASCII(host), { all: true }, (err, addresses) => {\n        signal.removeEventListener('abort', onAbort);\n\n        err ? reject(err) : resolve(addresses);\n      });\n    });\n  }\n\n  return await sendInParallel(addresses, port, request, signal);\n}\n"],"mappings":"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"},"metadata":{},"sourceType":"script"}