{"ast":null,"code":"/*! @azure/msal-browser v2.37.0 2023-05-01 */\n'use strict';\n\nimport { __extends, __awaiter, __generator, __rest, __assign } from '../_virtual/_tslib.js';\nimport { ScopeSet, AuthToken, Constants, AccountEntity, AuthorityType, IdTokenEntity, AccessTokenEntity, PerformanceEvents, TimeUtils, ClientAuthError, AuthenticationScheme, PopTokenGenerator, UrlString, OIDC_DEFAULT_SCOPES, PromptValue } from '@azure/msal-common';\nimport { BaseInteractionClient } from './BaseInteractionClient.js';\nimport { TemporaryCacheKeys, NativeExtensionMethod, NativeConstants, ApiId } from '../utils/BrowserConstants.js';\nimport { NativeAuthError } from '../error/NativeAuthError.js';\nimport { BrowserAuthError } from '../error/BrowserAuthError.js';\nimport { SilentCacheClient } from './SilentCacheClient.js';\n\n/*\r\n * Copyright (c) Microsoft Corporation. All rights reserved.\r\n * Licensed under the MIT License.\r\n */\nvar NativeInteractionClient = /** @class */function (_super) {\n  __extends(NativeInteractionClient, _super);\n  function NativeInteractionClient(config, browserStorage, browserCrypto, logger, eventHandler, navigationClient, apiId, performanceClient, provider, accountId, nativeStorageImpl, correlationId) {\n    var _this = _super.call(this, config, browserStorage, browserCrypto, logger, eventHandler, navigationClient, performanceClient, provider, correlationId) || this;\n    _this.apiId = apiId;\n    _this.accountId = accountId;\n    _this.nativeMessageHandler = provider;\n    _this.nativeStorageManager = nativeStorageImpl;\n    _this.silentCacheClient = new SilentCacheClient(config, _this.nativeStorageManager, browserCrypto, logger, eventHandler, navigationClient, performanceClient, provider, correlationId);\n    return _this;\n  }\n  /**\r\n   * Acquire token from native platform via browser extension\r\n   * @param request\r\n   */\n  NativeInteractionClient.prototype.acquireToken = function (request) {\n    return __awaiter(this, void 0, void 0, function () {\n      var nativeATMeasurement, reqTimestamp, nativeRequest, result, messageBody, response, validatedResponse;\n      return __generator(this, function (_a) {\n        switch (_a.label) {\n          case 0:\n            this.logger.trace(\"NativeInteractionClient - acquireToken called.\");\n            nativeATMeasurement = this.performanceClient.startMeasurement(PerformanceEvents.NativeInteractionClientAcquireToken, request.correlationId);\n            reqTimestamp = TimeUtils.nowSeconds();\n            return [4 /*yield*/, this.initializeNativeRequest(request)];\n          case 1:\n            nativeRequest = _a.sent();\n            _a.label = 2;\n          case 2:\n            _a.trys.push([2, 4,, 5]);\n            return [4 /*yield*/, this.acquireTokensFromCache(this.accountId, nativeRequest)];\n          case 3:\n            result = _a.sent();\n            nativeATMeasurement.endMeasurement({\n              success: true,\n              isNativeBroker: false,\n              fromCache: true\n            });\n            return [2 /*return*/, result];\n          case 4:\n            _a.sent();\n            // continue with a native call for any and all errors\n            this.logger.info(\"MSAL internal Cache does not contain tokens, proceed to make a native call\");\n            return [3 /*break*/, 5];\n          case 5:\n            messageBody = {\n              method: NativeExtensionMethod.GetToken,\n              request: nativeRequest\n            };\n            return [4 /*yield*/, this.nativeMessageHandler.sendMessage(messageBody)];\n          case 6:\n            response = _a.sent();\n            validatedResponse = this.validateNativeResponse(response);\n            return [2 /*return*/, this.handleNativeResponse(validatedResponse, nativeRequest, reqTimestamp).then(function (result) {\n              nativeATMeasurement.endMeasurement({\n                success: true,\n                isNativeBroker: true,\n                requestId: result.requestId\n              });\n              return result;\n            }).catch(function (error) {\n              nativeATMeasurement.endMeasurement({\n                success: false,\n                errorCode: error.errorCode,\n                subErrorCode: error.subError,\n                isNativeBroker: true\n              });\n              throw error;\n            })];\n        }\n      });\n    });\n  };\n  /**\r\n   * Creates silent flow request\r\n   * @param request\r\n   * @param cachedAccount\r\n   * @returns CommonSilentFlowRequest\r\n   */\n  NativeInteractionClient.prototype.createSilentCacheRequest = function (request, cachedAccount) {\n    return {\n      authority: request.authority,\n      correlationId: this.correlationId,\n      scopes: ScopeSet.fromString(request.scope).asArray(),\n      account: cachedAccount,\n      forceRefresh: false\n    };\n  };\n  /**\r\n   * Fetches the tokens from the cache if un-expired\r\n   * @param nativeAccountId\r\n   * @param request\r\n   * @returns authenticationResult\r\n   */\n  NativeInteractionClient.prototype.acquireTokensFromCache = function (nativeAccountId, request) {\n    return __awaiter(this, void 0, void 0, function () {\n      var account, silentRequest, result, e_2;\n      return __generator(this, function (_a) {\n        switch (_a.label) {\n          case 0:\n            if (!nativeAccountId) {\n              this.logger.warning(\"NativeInteractionClient:acquireTokensFromCache - No nativeAccountId provided\");\n              throw ClientAuthError.createNoAccountFoundError();\n            }\n            account = this.browserStorage.getAccountInfoFilteredBy({\n              nativeAccountId: nativeAccountId\n            });\n            if (!account) {\n              throw ClientAuthError.createNoAccountFoundError();\n            }\n            _a.label = 1;\n          case 1:\n            _a.trys.push([1, 3,, 4]);\n            silentRequest = this.createSilentCacheRequest(request, account);\n            return [4 /*yield*/, this.silentCacheClient.acquireToken(silentRequest)];\n          case 2:\n            result = _a.sent();\n            return [2 /*return*/, result];\n          case 3:\n            e_2 = _a.sent();\n            throw e_2;\n          case 4:\n            return [2 /*return*/];\n        }\n      });\n    });\n  };\n  /**\r\n   * Acquires a token from native platform then redirects to the redirectUri instead of returning the response\r\n   * @param request\r\n   */\n  NativeInteractionClient.prototype.acquireTokenRedirect = function (request) {\n    return __awaiter(this, void 0, void 0, function () {\n      var nativeRequest, messageBody, response, e_3, navigationOptions, redirectUri;\n      return __generator(this, function (_a) {\n        switch (_a.label) {\n          case 0:\n            this.logger.trace(\"NativeInteractionClient - acquireTokenRedirect called.\");\n            return [4 /*yield*/, this.initializeNativeRequest(request)];\n          case 1:\n            nativeRequest = _a.sent();\n            messageBody = {\n              method: NativeExtensionMethod.GetToken,\n              request: nativeRequest\n            };\n            _a.label = 2;\n          case 2:\n            _a.trys.push([2, 4,, 5]);\n            return [4 /*yield*/, this.nativeMessageHandler.sendMessage(messageBody)];\n          case 3:\n            response = _a.sent();\n            this.validateNativeResponse(response);\n            return [3 /*break*/, 5];\n          case 4:\n            e_3 = _a.sent();\n            // Only throw fatal errors here to allow application to fallback to regular redirect. Otherwise proceed and the error will be thrown in handleRedirectPromise\n            if (e_3 instanceof NativeAuthError && e_3.isFatal()) {\n              throw e_3;\n            }\n            return [3 /*break*/, 5];\n          case 5:\n            this.browserStorage.setTemporaryCache(TemporaryCacheKeys.NATIVE_REQUEST, JSON.stringify(nativeRequest), true);\n            navigationOptions = {\n              apiId: ApiId.acquireTokenRedirect,\n              timeout: this.config.system.redirectNavigationTimeout,\n              noHistory: false\n            };\n            redirectUri = this.config.auth.navigateToLoginRequestUrl ? window.location.href : this.getRedirectUri(request.redirectUri);\n            return [4 /*yield*/, this.navigationClient.navigateExternal(redirectUri, navigationOptions)];\n          case 6:\n            _a.sent(); // Need to treat this as external to ensure handleRedirectPromise is run again\n            return [2 /*return*/];\n        }\n      });\n    });\n  };\n  /**\r\n   * If the previous page called native platform for a token using redirect APIs, send the same request again and return the response\r\n   */\n  NativeInteractionClient.prototype.handleRedirectPromise = function () {\n    return __awaiter(this, void 0, void 0, function () {\n      var cachedRequest, prompt, request, messageBody, reqTimestamp, response, result, e_4;\n      return __generator(this, function (_a) {\n        switch (_a.label) {\n          case 0:\n            this.logger.trace(\"NativeInteractionClient - handleRedirectPromise called.\");\n            if (!this.browserStorage.isInteractionInProgress(true)) {\n              this.logger.info(\"handleRedirectPromise called but there is no interaction in progress, returning null.\");\n              return [2 /*return*/, null];\n            }\n            cachedRequest = this.browserStorage.getCachedNativeRequest();\n            if (!cachedRequest) {\n              this.logger.verbose(\"NativeInteractionClient - handleRedirectPromise called but there is no cached request, returning null.\");\n              return [2 /*return*/, null];\n            }\n            prompt = cachedRequest.prompt, request = __rest(cachedRequest, [\"prompt\"]);\n            if (prompt) {\n              this.logger.verbose(\"NativeInteractionClient - handleRedirectPromise called and prompt was included in the original request, removing prompt from cached request to prevent second interaction with native broker window.\");\n            }\n            this.browserStorage.removeItem(this.browserStorage.generateCacheKey(TemporaryCacheKeys.NATIVE_REQUEST));\n            messageBody = {\n              method: NativeExtensionMethod.GetToken,\n              request: request\n            };\n            reqTimestamp = TimeUtils.nowSeconds();\n            _a.label = 1;\n          case 1:\n            _a.trys.push([1, 3,, 4]);\n            this.logger.verbose(\"NativeInteractionClient - handleRedirectPromise sending message to native broker.\");\n            return [4 /*yield*/, this.nativeMessageHandler.sendMessage(messageBody)];\n          case 2:\n            response = _a.sent();\n            this.validateNativeResponse(response);\n            result = this.handleNativeResponse(response, request, reqTimestamp);\n            this.browserStorage.setInteractionInProgress(false);\n            return [2 /*return*/, result];\n          case 3:\n            e_4 = _a.sent();\n            this.browserStorage.setInteractionInProgress(false);\n            throw e_4;\n          case 4:\n            return [2 /*return*/];\n        }\n      });\n    });\n  };\n  /**\r\n   * Logout from native platform via browser extension\r\n   * @param request\r\n   */\n  NativeInteractionClient.prototype.logout = function () {\n    this.logger.trace(\"NativeInteractionClient - logout called.\");\n    return Promise.reject(\"Logout not implemented yet\");\n  };\n  /**\r\n   * Transform response from native platform into AuthenticationResult object which will be returned to the end user\r\n   * @param response\r\n   * @param request\r\n   * @param reqTimestamp\r\n   */\n  NativeInteractionClient.prototype.handleNativeResponse = function (response, request, reqTimestamp) {\n    return __awaiter(this, void 0, void 0, function () {\n      var authority, authorityPreferredCache, idTokenObj, homeAccountIdentifier, accountEntity, result;\n      return __generator(this, function (_a) {\n        switch (_a.label) {\n          case 0:\n            this.logger.trace(\"NativeInteractionClient - handleNativeResponse called.\");\n            if (response.account.id !== request.accountId) {\n              // User switch in native broker prompt is not supported. All users must first sign in through web flow to ensure server state is in sync\n              throw NativeAuthError.createUserSwitchError();\n            }\n            return [4 /*yield*/, this.getDiscoveredAuthority(request.authority)];\n          case 1:\n            authority = _a.sent();\n            authorityPreferredCache = authority.getPreferredCache();\n            idTokenObj = this.createIdTokenObj(response);\n            homeAccountIdentifier = this.createHomeAccountIdentifier(response, idTokenObj);\n            accountEntity = this.createAccountEntity(response, homeAccountIdentifier, idTokenObj, authorityPreferredCache);\n            return [4 /*yield*/, this.generateAuthenticationResult(response, request, idTokenObj, accountEntity, authority.canonicalAuthority, reqTimestamp)];\n          case 2:\n            result = _a.sent();\n            // cache accounts and tokens in the appropriate storage\n            this.cacheAccount(accountEntity);\n            this.cacheNativeTokens(response, request, homeAccountIdentifier, idTokenObj, result.accessToken, result.tenantId, reqTimestamp);\n            return [2 /*return*/, result];\n        }\n      });\n    });\n  };\n  /**\r\n   * Create an idToken Object (not entity)\r\n   * @param response\r\n   * @returns\r\n   */\n  NativeInteractionClient.prototype.createIdTokenObj = function (response) {\n    return new AuthToken(response.id_token || Constants.EMPTY_STRING, this.browserCrypto);\n  };\n  /**\r\n   * creates an homeAccountIdentifier for the account\r\n   * @param response\r\n   * @param idTokenObj\r\n   * @returns\r\n   */\n  NativeInteractionClient.prototype.createHomeAccountIdentifier = function (response, idTokenObj) {\n    // Save account in browser storage\n    var homeAccountIdentifier = AccountEntity.generateHomeAccountId(response.client_info || Constants.EMPTY_STRING, AuthorityType.Default, this.logger, this.browserCrypto, idTokenObj);\n    return homeAccountIdentifier;\n  };\n  /**\r\n   * Creates account entity\r\n   * @param response\r\n   * @param homeAccountIdentifier\r\n   * @param idTokenObj\r\n   * @param authority\r\n   * @returns\r\n   */\n  NativeInteractionClient.prototype.createAccountEntity = function (response, homeAccountIdentifier, idTokenObj, authority) {\n    return AccountEntity.createAccount(response.client_info, homeAccountIdentifier, idTokenObj, undefined, undefined, undefined, authority, response.account.id);\n  };\n  /**\r\n   * Helper to generate scopes\r\n   * @param response\r\n   * @param request\r\n   * @returns\r\n   */\n  NativeInteractionClient.prototype.generateScopes = function (response, request) {\n    return response.scope ? ScopeSet.fromString(response.scope) : ScopeSet.fromString(request.scope);\n  };\n  /**\r\n   * If PoP token is requesred, records the PoP token if returned from the WAM, else generates one in the browser\r\n   * @param request\r\n   * @param response\r\n   */\n  NativeInteractionClient.prototype.generatePopAccessToken = function (response, request) {\n    return __awaiter(this, void 0, void 0, function () {\n      var popTokenGenerator, shrParameters;\n      return __generator(this, function (_a) {\n        switch (_a.label) {\n          case 0:\n            if (!(request.tokenType === AuthenticationScheme.POP)) return [3 /*break*/, 2];\n            /**\r\n             * This code prioritizes SHR returned from the native layer. In case of error/SHR not calculated from WAM and the AT\r\n             * is still received, SHR is calculated locally\r\n             */\n            // Check if native layer returned an SHR token\n            if (response.shr) {\n              this.logger.trace(\"handleNativeServerResponse: SHR is enabled in native layer\");\n              return [2 /*return*/, response.shr];\n            }\n            popTokenGenerator = new PopTokenGenerator(this.browserCrypto);\n            shrParameters = {\n              resourceRequestMethod: request.resourceRequestMethod,\n              resourceRequestUri: request.resourceRequestUri,\n              shrClaims: request.shrClaims,\n              shrNonce: request.shrNonce\n            };\n            /**\r\n             * KeyID must be present in the native request from when the PoP key was generated in order for\r\n             * PopTokenGenerator to query the full key for signing\r\n             */\n            if (!request.keyId) {\n              throw ClientAuthError.createKeyIdMissingError();\n            }\n            return [4 /*yield*/, popTokenGenerator.signPopToken(response.access_token, request.keyId, shrParameters)];\n          case 1:\n            return [2 /*return*/, _a.sent()];\n          case 2:\n            return [2 /*return*/, response.access_token];\n        }\n      });\n    });\n  };\n  /**\r\n   * Generates authentication result\r\n   * @param response\r\n   * @param request\r\n   * @param idTokenObj\r\n   * @param accountEntity\r\n   * @param authority\r\n   * @param reqTimestamp\r\n   * @returns\r\n   */\n  NativeInteractionClient.prototype.generateAuthenticationResult = function (response, request, idTokenObj, accountEntity, authority, reqTimestamp) {\n    return __awaiter(this, void 0, void 0, function () {\n      var mats, responseScopes, accountProperties, uid, tid, responseAccessToken, tokenType, result;\n      return __generator(this, function (_a) {\n        switch (_a.label) {\n          case 0:\n            mats = this.addTelemetryFromNativeResponse(response);\n            responseScopes = response.scope ? ScopeSet.fromString(response.scope) : ScopeSet.fromString(request.scope);\n            accountProperties = response.account.properties || {};\n            uid = accountProperties[\"UID\"] || idTokenObj.claims.oid || idTokenObj.claims.sub || Constants.EMPTY_STRING;\n            tid = accountProperties[\"TenantId\"] || idTokenObj.claims.tid || Constants.EMPTY_STRING;\n            return [4 /*yield*/, this.generatePopAccessToken(response, request)];\n          case 1:\n            responseAccessToken = _a.sent();\n            tokenType = request.tokenType === AuthenticationScheme.POP ? AuthenticationScheme.POP : AuthenticationScheme.BEARER;\n            result = {\n              authority: authority,\n              uniqueId: uid,\n              tenantId: tid,\n              scopes: responseScopes.asArray(),\n              account: accountEntity.getAccountInfo(),\n              idToken: response.id_token,\n              idTokenClaims: idTokenObj.claims,\n              accessToken: responseAccessToken,\n              fromCache: mats ? this.isResponseFromCache(mats) : false,\n              expiresOn: new Date(Number(reqTimestamp + response.expires_in) * 1000),\n              tokenType: tokenType,\n              correlationId: this.correlationId,\n              state: response.state,\n              fromNativeBroker: true\n            };\n            return [2 /*return*/, result];\n        }\n      });\n    });\n  };\n  /**\r\n   * cache the account entity in browser storage\r\n   * @param accountEntity\r\n   */\n  NativeInteractionClient.prototype.cacheAccount = function (accountEntity) {\n    var _this = this;\n    // Store the account info and hence `nativeAccountId` in browser cache\n    this.browserStorage.setAccount(accountEntity);\n    // Remove any existing cached tokens for this account in browser storage\n    this.browserStorage.removeAccountContext(accountEntity).catch(function (e) {\n      _this.logger.error(\"Error occurred while removing account context from browser storage. \" + e);\n    });\n  };\n  /**\r\n   * Stores the access_token and id_token in inmemory storage\r\n   * @param response\r\n   * @param request\r\n   * @param homeAccountIdentifier\r\n   * @param idTokenObj\r\n   * @param responseAccessToken\r\n   * @param tenantId\r\n   * @param reqTimestamp\r\n   */\n  NativeInteractionClient.prototype.cacheNativeTokens = function (response, request, homeAccountIdentifier, idTokenObj, responseAccessToken, tenantId, reqTimestamp) {\n    // cache idToken in inmemory storage\n    var idTokenEntity = IdTokenEntity.createIdTokenEntity(homeAccountIdentifier, request.authority, response.id_token || Constants.EMPTY_STRING, request.clientId, idTokenObj.claims.tid || Constants.EMPTY_STRING);\n    this.nativeStorageManager.setIdTokenCredential(idTokenEntity);\n    // cache accessToken in inmemory storage\n    var expiresIn = request.tokenType === AuthenticationScheme.POP ? Constants.SHR_NONCE_VALIDITY : (typeof response.expires_in === \"string\" ? parseInt(response.expires_in, 10) : response.expires_in) || 0;\n    var tokenExpirationSeconds = reqTimestamp + expiresIn;\n    var responseScopes = this.generateScopes(response, request);\n    var accessTokenEntity = AccessTokenEntity.createAccessTokenEntity(homeAccountIdentifier, request.authority, responseAccessToken, request.clientId, tenantId, responseScopes.printScopes(), tokenExpirationSeconds, 0, this.browserCrypto);\n    this.nativeStorageManager.setAccessTokenCredential(accessTokenEntity);\n  };\n  NativeInteractionClient.prototype.addTelemetryFromNativeResponse = function (response) {\n    var mats = this.getMATSFromResponse(response);\n    if (!mats) {\n      return null;\n    }\n    this.performanceClient.addStaticFields({\n      extensionId: this.nativeMessageHandler.getExtensionId(),\n      extensionVersion: this.nativeMessageHandler.getExtensionVersion(),\n      matsBrokerVersion: mats.broker_version,\n      matsAccountJoinOnStart: mats.account_join_on_start,\n      matsAccountJoinOnEnd: mats.account_join_on_end,\n      matsDeviceJoin: mats.device_join,\n      matsPromptBehavior: mats.prompt_behavior,\n      matsApiErrorCode: mats.api_error_code,\n      matsUiVisible: mats.ui_visible,\n      matsSilentCode: mats.silent_code,\n      matsSilentBiSubCode: mats.silent_bi_sub_code,\n      matsSilentMessage: mats.silent_message,\n      matsSilentStatus: mats.silent_status,\n      matsHttpStatus: mats.http_status,\n      matsHttpEventCount: mats.http_event_count\n    }, this.correlationId);\n    return mats;\n  };\n  /**\r\n   * Validates native platform response before processing\r\n   * @param response\r\n   */\n  NativeInteractionClient.prototype.validateNativeResponse = function (response) {\n    if (response.hasOwnProperty(\"access_token\") && response.hasOwnProperty(\"id_token\") && response.hasOwnProperty(\"client_info\") && response.hasOwnProperty(\"account\") && response.hasOwnProperty(\"scope\") && response.hasOwnProperty(\"expires_in\")) {\n      return response;\n    } else {\n      throw NativeAuthError.createUnexpectedError(\"Response missing expected properties.\");\n    }\n  };\n  /**\r\n   * Gets MATS telemetry from native response\r\n   * @param response\r\n   * @returns\r\n   */\n  NativeInteractionClient.prototype.getMATSFromResponse = function (response) {\n    if (response.properties.MATS) {\n      try {\n        return JSON.parse(response.properties.MATS);\n      } catch (e) {\n        this.logger.error(\"NativeInteractionClient - Error parsing MATS telemetry, returning null instead\");\n      }\n    }\n    return null;\n  };\n  /**\r\n   * Returns whether or not response came from native cache\r\n   * @param response\r\n   * @returns\r\n   */\n  NativeInteractionClient.prototype.isResponseFromCache = function (mats) {\n    if (typeof mats.is_cached === \"undefined\") {\n      this.logger.verbose(\"NativeInteractionClient - MATS telemetry does not contain field indicating if response was served from cache. Returning false.\");\n      return false;\n    }\n    return !!mats.is_cached;\n  };\n  /**\r\n   * Translates developer provided request object into NativeRequest object\r\n   * @param request\r\n   */\n  NativeInteractionClient.prototype.initializeNativeRequest = function (request) {\n    return __awaiter(this, void 0, void 0, function () {\n      var authority, canonicalAuthority, scopes, remainingProperties, scopeSet, getPrompt, validatedRequest, shrParameters, popTokenGenerator, reqCnfData;\n      var _this = this;\n      return __generator(this, function (_a) {\n        switch (_a.label) {\n          case 0:\n            this.logger.trace(\"NativeInteractionClient - initializeNativeRequest called\");\n            authority = request.authority || this.config.auth.authority;\n            canonicalAuthority = new UrlString(authority);\n            canonicalAuthority.validateAsUri();\n            scopes = request.scopes, remainingProperties = __rest(request, [\"scopes\"]);\n            scopeSet = new ScopeSet(scopes || []);\n            scopeSet.appendScopes(OIDC_DEFAULT_SCOPES);\n            getPrompt = function getPrompt() {\n              // If request is silent, prompt is always none\n              switch (_this.apiId) {\n                case ApiId.ssoSilent:\n                case ApiId.acquireTokenSilent_silentFlow:\n                  _this.logger.trace(\"initializeNativeRequest: silent request sets prompt to none\");\n                  return PromptValue.NONE;\n              }\n              // Prompt not provided, request may proceed and native broker decides if it needs to prompt\n              if (!request.prompt) {\n                _this.logger.trace(\"initializeNativeRequest: prompt was not provided\");\n                return undefined;\n              }\n              // If request is interactive, check if prompt provided is allowed to go directly to native broker\n              switch (request.prompt) {\n                case PromptValue.NONE:\n                case PromptValue.CONSENT:\n                case PromptValue.LOGIN:\n                  _this.logger.trace(\"initializeNativeRequest: prompt is compatible with native flow\");\n                  return request.prompt;\n                default:\n                  _this.logger.trace(\"initializeNativeRequest: prompt = \" + request.prompt + \" is not compatible with native flow\");\n                  throw BrowserAuthError.createNativePromptParameterNotSupportedError();\n              }\n            };\n            validatedRequest = __assign(__assign({}, remainingProperties), {\n              accountId: this.accountId,\n              clientId: this.config.auth.clientId,\n              authority: canonicalAuthority.urlString,\n              scope: scopeSet.printScopes(),\n              redirectUri: this.getRedirectUri(request.redirectUri),\n              prompt: getPrompt(),\n              correlationId: this.correlationId,\n              tokenType: request.authenticationScheme,\n              windowTitleSubstring: document.title,\n              extraParameters: __assign(__assign(__assign({}, request.extraQueryParameters), request.tokenQueryParameters), {\n                telemetry: NativeConstants.MATS_TELEMETRY\n              }),\n              extendedExpiryToken: false // Make this configurable?\n            });\n\n            if (!(request.authenticationScheme === AuthenticationScheme.POP)) return [3 /*break*/, 2];\n            shrParameters = {\n              resourceRequestUri: request.resourceRequestUri,\n              resourceRequestMethod: request.resourceRequestMethod,\n              shrClaims: request.shrClaims,\n              shrNonce: request.shrNonce\n            };\n            popTokenGenerator = new PopTokenGenerator(this.browserCrypto);\n            return [4 /*yield*/, popTokenGenerator.generateCnf(shrParameters)];\n          case 1:\n            reqCnfData = _a.sent();\n            // to reduce the URL length, it is recommended to send the hash of the req_cnf instead of the whole string\n            validatedRequest.reqCnf = reqCnfData.reqCnfHash;\n            validatedRequest.keyId = reqCnfData.kid;\n            _a.label = 2;\n          case 2:\n            return [2 /*return*/, validatedRequest];\n        }\n      });\n    });\n  };\n  return NativeInteractionClient;\n}(BaseInteractionClient);\nexport { NativeInteractionClient };","map":{"version":3,"names":["__extends","NativeInteractionClient","_super","config","browserStorage","browserCrypto","logger","eventHandler","navigationClient","apiId","performanceClient","provider","accountId","nativeStorageImpl","correlationId","_this","call","nativeMessageHandler","nativeStorageManager","silentCacheClient","SilentCacheClient","prototype","acquireToken","request","trace","nativeATMeasurement","startMeasurement","PerformanceEvents","NativeInteractionClientAcquireToken","reqTimestamp","TimeUtils","nowSeconds","initializeNativeRequest","nativeRequest","_a","sent","acquireTokensFromCache","result","endMeasurement","success","isNativeBroker","fromCache","info","messageBody","method","NativeExtensionMethod","GetToken","sendMessage","response","validatedResponse","validateNativeResponse","handleNativeResponse","then","requestId","catch","error","errorCode","subErrorCode","subError","createSilentCacheRequest","cachedAccount","authority","scopes","ScopeSet","fromString","scope","asArray","account","forceRefresh","nativeAccountId","warning","ClientAuthError","createNoAccountFoundError","getAccountInfoFilteredBy","silentRequest","e_2","acquireTokenRedirect","e_3","NativeAuthError","isFatal","setTemporaryCache","TemporaryCacheKeys","NATIVE_REQUEST","JSON","stringify","navigationOptions","ApiId","timeout","system","redirectNavigationTimeout","noHistory","redirectUri","auth","navigateToLoginRequestUrl","window","location","href","getRedirectUri","navigateExternal","handleRedirectPromise","isInteractionInProgress","cachedRequest","getCachedNativeRequest","verbose","prompt","__rest","removeItem","generateCacheKey","setInteractionInProgress","e_4","logout","Promise","reject","id","createUserSwitchError","getDiscoveredAuthority","authorityPreferredCache","getPreferredCache","idTokenObj","createIdTokenObj","homeAccountIdentifier","createHomeAccountIdentifier","accountEntity","createAccountEntity","generateAuthenticationResult","canonicalAuthority","cacheAccount","cacheNativeTokens","accessToken","tenantId","AuthToken","id_token","Constants","EMPTY_STRING","AccountEntity","generateHomeAccountId","client_info","AuthorityType","Default","createAccount","undefined","generateScopes","generatePopAccessToken","tokenType","AuthenticationScheme","POP","shr","popTokenGenerator","PopTokenGenerator","shrParameters","resourceRequestMethod","resourceRequestUri","shrClaims","shrNonce","keyId","createKeyIdMissingError","signPopToken","access_token","mats","addTelemetryFromNativeResponse","responseScopes","accountProperties","properties","uid","claims","oid","sub","tid","responseAccessToken","BEARER","uniqueId","getAccountInfo","idToken","idTokenClaims","isResponseFromCache","expiresOn","Date","Number","expires_in","state","fromNativeBroker","setAccount","removeAccountContext","e","idTokenEntity","IdTokenEntity","createIdTokenEntity","clientId","setIdTokenCredential","expiresIn","SHR_NONCE_VALIDITY","parseInt","tokenExpirationSeconds","accessTokenEntity","AccessTokenEntity","createAccessTokenEntity","printScopes","setAccessTokenCredential","getMATSFromResponse","addStaticFields","extensionId","getExtensionId","extensionVersion","getExtensionVersion","matsBrokerVersion","broker_version","matsAccountJoinOnStart","account_join_on_start","matsAccountJoinOnEnd","account_join_on_end","matsDeviceJoin","device_join","matsPromptBehavior","prompt_behavior","matsApiErrorCode","api_error_code","matsUiVisible","ui_visible","matsSilentCode","silent_code","matsSilentBiSubCode","silent_bi_sub_code","matsSilentMessage","silent_message","matsSilentStatus","silent_status","matsHttpStatus","http_status","matsHttpEventCount","http_event_count","hasOwnProperty","createUnexpectedError","MATS","parse","is_cached","UrlString","validateAsUri","remainingProperties","scopeSet","appendScopes","OIDC_DEFAULT_SCOPES","getPrompt","ssoSilent","acquireTokenSilent_silentFlow","PromptValue","NONE","CONSENT","LOGIN","BrowserAuthError","createNativePromptParameterNotSupportedError","validatedRequest","__assign","urlString","authenticationScheme","windowTitleSubstring","document","title","extraParameters","extraQueryParameters","tokenQueryParameters","telemetry","NativeConstants","MATS_TELEMETRY","extendedExpiryToken","generateCnf","reqCnfData","reqCnf","reqCnfHash","kid","BaseInteractionClient"],"sources":["../../src/interaction_client/NativeInteractionClient.ts"],"sourcesContent":["/*\r\n * Copyright (c) Microsoft Corporation. All rights reserved.\r\n * Licensed under the MIT License.\r\n */\r\n\r\nimport { AuthenticationResult, Logger, ICrypto, PromptValue, AuthToken, Constants, AccountEntity, AuthorityType, ScopeSet, TimeUtils, AuthenticationScheme, UrlString, OIDC_DEFAULT_SCOPES, PopTokenGenerator, SignedHttpRequestParameters, IPerformanceClient, PerformanceEvents, IdTokenEntity, AccessTokenEntity, ClientAuthError, AuthError, CommonSilentFlowRequest, AccountInfo } from \"@azure/msal-common\";\r\nimport { BaseInteractionClient } from \"./BaseInteractionClient\";\r\nimport { BrowserConfiguration } from \"../config/Configuration\";\r\nimport { BrowserCacheManager } from \"../cache/BrowserCacheManager\";\r\nimport { EventHandler } from \"../event/EventHandler\";\r\nimport { PopupRequest } from \"../request/PopupRequest\";\r\nimport { SilentRequest } from \"../request/SilentRequest\";\r\nimport { SsoSilentRequest } from \"../request/SsoSilentRequest\";\r\nimport { NativeMessageHandler } from \"../broker/nativeBroker/NativeMessageHandler\";\r\nimport { NativeExtensionMethod, ApiId, TemporaryCacheKeys, NativeConstants } from \"../utils/BrowserConstants\";\r\nimport { NativeExtensionRequestBody, NativeTokenRequest } from \"../broker/nativeBroker/NativeRequest\";\r\nimport { MATS, NativeResponse } from \"../broker/nativeBroker/NativeResponse\";\r\nimport { NativeAuthError } from \"../error/NativeAuthError\";\r\nimport { RedirectRequest } from \"../request/RedirectRequest\";\r\nimport { NavigationOptions } from \"../navigation/NavigationOptions\";\r\nimport { INavigationClient } from \"../navigation/INavigationClient\";\r\nimport { BrowserAuthError } from \"../error/BrowserAuthError\";\r\nimport { SilentCacheClient } from \"./SilentCacheClient\";\r\n\r\nexport class NativeInteractionClient extends BaseInteractionClient {\r\n    protected apiId: ApiId;\r\n    protected accountId: string;\r\n    protected nativeMessageHandler: NativeMessageHandler;\r\n    protected silentCacheClient: SilentCacheClient;\r\n    protected nativeStorageManager: BrowserCacheManager;\r\n\r\n    constructor(config: BrowserConfiguration, browserStorage: BrowserCacheManager, browserCrypto: ICrypto, logger: Logger, eventHandler: EventHandler, navigationClient: INavigationClient, apiId: ApiId, performanceClient: IPerformanceClient, provider: NativeMessageHandler, accountId: string, nativeStorageImpl: BrowserCacheManager, correlationId?: string) {\r\n        super(config, browserStorage, browserCrypto, logger, eventHandler, navigationClient, performanceClient, provider, correlationId);\r\n        this.apiId = apiId;\r\n        this.accountId = accountId;\r\n        this.nativeMessageHandler = provider;\r\n        this.nativeStorageManager = nativeStorageImpl;\r\n        this.silentCacheClient = new SilentCacheClient(config, this.nativeStorageManager, browserCrypto, logger, eventHandler, navigationClient, performanceClient, provider, correlationId);\r\n    }\r\n\r\n    /**\r\n     * Acquire token from native platform via browser extension\r\n     * @param request\r\n     */\r\n    async acquireToken(request: PopupRequest|SilentRequest|SsoSilentRequest): Promise<AuthenticationResult> {\r\n        this.logger.trace(\"NativeInteractionClient - acquireToken called.\");\r\n\r\n        // start the perf measurement\r\n        const nativeATMeasurement = this.performanceClient.startMeasurement(PerformanceEvents.NativeInteractionClientAcquireToken, request.correlationId);\r\n        const reqTimestamp = TimeUtils.nowSeconds();\r\n\r\n        // initialize native request\r\n        const nativeRequest = await this.initializeNativeRequest(request);\r\n        \r\n        // check if the tokens can be retrieved from internal cache\r\n        try {\r\n            const result = await this.acquireTokensFromCache(this.accountId, nativeRequest);\r\n            nativeATMeasurement.endMeasurement({\r\n                success: true,\r\n                isNativeBroker: false, // Should be true only when the result is coming directly from the broker\r\n                fromCache: true\r\n            });\r\n            return result;\r\n        } catch (e) {\r\n            // continue with a native call for any and all errors\r\n            this.logger.info(\"MSAL internal Cache does not contain tokens, proceed to make a native call\");\r\n        }\r\n\r\n        // fall back to native calls\r\n        const messageBody: NativeExtensionRequestBody = {\r\n            method: NativeExtensionMethod.GetToken,\r\n            request: nativeRequest\r\n        };\r\n\r\n        const response: object = await this.nativeMessageHandler.sendMessage(messageBody);\r\n        const validatedResponse: NativeResponse = this.validateNativeResponse(response);\r\n\r\n        return this.handleNativeResponse(validatedResponse, nativeRequest, reqTimestamp)\r\n            .then((result: AuthenticationResult) => {\r\n                nativeATMeasurement.endMeasurement({\r\n                    success: true,\r\n                    isNativeBroker: true,\r\n                    requestId: result.requestId\r\n                });\r\n                return result;\r\n            })\r\n            .catch((error: AuthError) => {\r\n                nativeATMeasurement.endMeasurement({\r\n                    success: false,\r\n                    errorCode: error.errorCode,\r\n                    subErrorCode: error.subError,\r\n                    isNativeBroker: true\r\n                });\r\n                throw error;\r\n            });\r\n    }\r\n\r\n    /**\r\n     * Creates silent flow request\r\n     * @param request\r\n     * @param cachedAccount\r\n     * @returns CommonSilentFlowRequest\r\n     */\r\n    private createSilentCacheRequest(request: NativeTokenRequest, cachedAccount: AccountInfo): CommonSilentFlowRequest {\r\n        return {\r\n            authority: request.authority,\r\n            correlationId: this.correlationId,\r\n            scopes: ScopeSet.fromString(request.scope).asArray(),\r\n            account: cachedAccount,\r\n            forceRefresh: false,\r\n        };\r\n    }\r\n\r\n    /**\r\n     * Fetches the tokens from the cache if un-expired\r\n     * @param nativeAccountId\r\n     * @param request\r\n     * @returns authenticationResult\r\n     */\r\n    protected async acquireTokensFromCache(nativeAccountId: string, request: NativeTokenRequest): Promise<AuthenticationResult> {\r\n        if (!nativeAccountId) {\r\n            this.logger.warning(\"NativeInteractionClient:acquireTokensFromCache - No nativeAccountId provided\");\r\n            throw ClientAuthError.createNoAccountFoundError();\r\n        }\r\n        // fetch the account from in-memory cache\r\n        const account = this.browserStorage.getAccountInfoFilteredBy({nativeAccountId});\r\n        if (!account) {\r\n            throw ClientAuthError.createNoAccountFoundError();\r\n        }\r\n\r\n        // leverage silent flow for cached tokens retrieval\r\n        try {\r\n            const silentRequest = this.createSilentCacheRequest(request, account);\r\n            const result = await this.silentCacheClient.acquireToken(silentRequest);\r\n            return result;\r\n        } catch (e) {\r\n            throw e;\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Acquires a token from native platform then redirects to the redirectUri instead of returning the response\r\n     * @param request\r\n     */\r\n    async acquireTokenRedirect(request: RedirectRequest): Promise<void> {\r\n        this.logger.trace(\"NativeInteractionClient - acquireTokenRedirect called.\");\r\n        const nativeRequest = await this.initializeNativeRequest(request);\r\n\r\n        const messageBody: NativeExtensionRequestBody = {\r\n            method: NativeExtensionMethod.GetToken,\r\n            request: nativeRequest\r\n        };\r\n\r\n        try {\r\n            const response: object = await this.nativeMessageHandler.sendMessage(messageBody);\r\n            this.validateNativeResponse(response);\r\n        } catch (e) {\r\n            // Only throw fatal errors here to allow application to fallback to regular redirect. Otherwise proceed and the error will be thrown in handleRedirectPromise\r\n            if (e instanceof NativeAuthError && e.isFatal()) {\r\n                throw e;\r\n            }\r\n        }\r\n        this.browserStorage.setTemporaryCache(TemporaryCacheKeys.NATIVE_REQUEST, JSON.stringify(nativeRequest), true);\r\n\r\n        const navigationOptions: NavigationOptions = {\r\n            apiId: ApiId.acquireTokenRedirect,\r\n            timeout: this.config.system.redirectNavigationTimeout,\r\n            noHistory: false\r\n        };\r\n        const redirectUri = this.config.auth.navigateToLoginRequestUrl ? window.location.href : this.getRedirectUri(request.redirectUri);\r\n        await this.navigationClient.navigateExternal(redirectUri, navigationOptions); // Need to treat this as external to ensure handleRedirectPromise is run again\r\n    }\r\n\r\n    /**\r\n     * If the previous page called native platform for a token using redirect APIs, send the same request again and return the response\r\n     */\r\n    async handleRedirectPromise(): Promise<AuthenticationResult | null> {\r\n        this.logger.trace(\"NativeInteractionClient - handleRedirectPromise called.\");\r\n        if (!this.browserStorage.isInteractionInProgress(true)) {\r\n            this.logger.info(\"handleRedirectPromise called but there is no interaction in progress, returning null.\");\r\n            return null;\r\n        }\r\n\r\n        // remove prompt from the request to prevent WAM from prompting twice\r\n        const cachedRequest = this.browserStorage.getCachedNativeRequest();\r\n        if (!cachedRequest) {\r\n            this.logger.verbose(\"NativeInteractionClient - handleRedirectPromise called but there is no cached request, returning null.\");\r\n            return null;\r\n        }\r\n\r\n        const { prompt, ...request} = cachedRequest;\r\n        if (prompt) {\r\n            this.logger.verbose(\"NativeInteractionClient - handleRedirectPromise called and prompt was included in the original request, removing prompt from cached request to prevent second interaction with native broker window.\");\r\n        }\r\n\r\n        this.browserStorage.removeItem(this.browserStorage.generateCacheKey(TemporaryCacheKeys.NATIVE_REQUEST));\r\n\r\n        const messageBody: NativeExtensionRequestBody = {\r\n            method: NativeExtensionMethod.GetToken,\r\n            request: request\r\n        };\r\n\r\n        const reqTimestamp = TimeUtils.nowSeconds();\r\n\r\n        try {\r\n            this.logger.verbose(\"NativeInteractionClient - handleRedirectPromise sending message to native broker.\");\r\n            const response: object = await this.nativeMessageHandler.sendMessage(messageBody);\r\n            this.validateNativeResponse(response);\r\n            const result = this.handleNativeResponse(response as NativeResponse, request, reqTimestamp);\r\n            this.browserStorage.setInteractionInProgress(false);\r\n            return result;\r\n        } catch (e) {\r\n            this.browserStorage.setInteractionInProgress(false);\r\n            throw e;\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Logout from native platform via browser extension\r\n     * @param request\r\n     */\r\n    logout(): Promise<void> {\r\n        this.logger.trace(\"NativeInteractionClient - logout called.\");\r\n        return Promise.reject(\"Logout not implemented yet\");\r\n    }\r\n\r\n    /**\r\n     * Transform response from native platform into AuthenticationResult object which will be returned to the end user\r\n     * @param response\r\n     * @param request\r\n     * @param reqTimestamp\r\n     */\r\n    protected async handleNativeResponse(response: NativeResponse, request: NativeTokenRequest, reqTimestamp: number): Promise<AuthenticationResult> {\r\n        this.logger.trace(\"NativeInteractionClient - handleNativeResponse called.\");\r\n\r\n        if (response.account.id !== request.accountId) {\r\n            // User switch in native broker prompt is not supported. All users must first sign in through web flow to ensure server state is in sync\r\n            throw NativeAuthError.createUserSwitchError();\r\n        }\r\n\r\n        // Get the preferred_cache domain for the given authority\r\n        const authority = await this.getDiscoveredAuthority(request.authority);\r\n        const authorityPreferredCache = authority.getPreferredCache();\r\n\r\n        // generate identifiers\r\n        const idTokenObj = this.createIdTokenObj(response);\r\n        const homeAccountIdentifier = this.createHomeAccountIdentifier(response, idTokenObj);\r\n        const accountEntity = this.createAccountEntity(response, homeAccountIdentifier, idTokenObj, authorityPreferredCache);\r\n\r\n        // generate authenticationResult\r\n        const result = await this.generateAuthenticationResult(response, request, idTokenObj, accountEntity, authority.canonicalAuthority, reqTimestamp);\r\n\r\n        // cache accounts and tokens in the appropriate storage\r\n        this.cacheAccount(accountEntity);\r\n        this.cacheNativeTokens(response, request, homeAccountIdentifier, idTokenObj, result.accessToken, result.tenantId, reqTimestamp);\r\n        \r\n        return result;\r\n    }\r\n\r\n    /**\r\n     * Create an idToken Object (not entity)\r\n     * @param response \r\n     * @returns \r\n     */\r\n    protected createIdTokenObj(response: NativeResponse): AuthToken {\r\n        return new AuthToken(response.id_token || Constants.EMPTY_STRING, this.browserCrypto);\r\n    }\r\n\r\n    /**\r\n     * creates an homeAccountIdentifier for the account\r\n     * @param response \r\n     * @param idTokenObj \r\n     * @returns \r\n     */\r\n    protected createHomeAccountIdentifier(response: NativeResponse, idTokenObj: AuthToken): string {\r\n        // Save account in browser storage\r\n        const homeAccountIdentifier = AccountEntity.generateHomeAccountId(response.client_info || Constants.EMPTY_STRING, AuthorityType.Default, this.logger, this.browserCrypto, idTokenObj);\r\n\r\n        return homeAccountIdentifier;\r\n    }\r\n\r\n    /**\r\n     * Creates account entity\r\n     * @param response \r\n     * @param homeAccountIdentifier \r\n     * @param idTokenObj \r\n     * @param authority \r\n     * @returns \r\n     */\r\n    protected createAccountEntity(response: NativeResponse, homeAccountIdentifier: string, idTokenObj: AuthToken, authority: string): AccountEntity {\r\n\r\n        return AccountEntity.createAccount(response.client_info, homeAccountIdentifier, idTokenObj, undefined, undefined, undefined, authority, response.account.id);\r\n    }\r\n\r\n    /**\r\n     * Helper to generate scopes\r\n     * @param response \r\n     * @param request \r\n     * @returns \r\n     */\r\n    generateScopes(response: NativeResponse, request: NativeTokenRequest): ScopeSet {\r\n        return response.scope ? ScopeSet.fromString(response.scope) : ScopeSet.fromString(request.scope);\r\n    }\r\n\r\n    /**\r\n     * If PoP token is requesred, records the PoP token if returned from the WAM, else generates one in the browser\r\n     * @param request \r\n     * @param response \r\n     */\r\n    async generatePopAccessToken(response: NativeResponse, request: NativeTokenRequest): Promise<string> {\r\n        \r\n        if(request.tokenType === AuthenticationScheme.POP) {\r\n            /** \r\n             * This code prioritizes SHR returned from the native layer. In case of error/SHR not calculated from WAM and the AT \r\n             * is still received, SHR is calculated locally\r\n             */\r\n        \r\n            // Check if native layer returned an SHR token\r\n            if (response.shr) {\r\n                this.logger.trace(\"handleNativeServerResponse: SHR is enabled in native layer\");\r\n                return response.shr;\r\n            }\r\n\r\n            // Generate SHR in msal js if WAM does not compute it when POP is enabled\r\n            const popTokenGenerator: PopTokenGenerator = new PopTokenGenerator(this.browserCrypto);\r\n            const shrParameters: SignedHttpRequestParameters = {\r\n                resourceRequestMethod: request.resourceRequestMethod,\r\n                resourceRequestUri: request.resourceRequestUri,\r\n                shrClaims: request.shrClaims,\r\n                shrNonce: request.shrNonce\r\n            };\r\n\r\n            /**\r\n             * KeyID must be present in the native request from when the PoP key was generated in order for\r\n             * PopTokenGenerator to query the full key for signing\r\n             */\r\n            if (!request.keyId) {\r\n                throw ClientAuthError.createKeyIdMissingError();\r\n            }\r\n            return await popTokenGenerator.signPopToken(response.access_token, request.keyId, shrParameters);\r\n        } else {\r\n            return response.access_token;\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Generates authentication result\r\n     * @param response \r\n     * @param request \r\n     * @param idTokenObj \r\n     * @param accountEntity \r\n     * @param authority \r\n     * @param reqTimestamp \r\n     * @returns \r\n     */\r\n    protected async generateAuthenticationResult(response: NativeResponse, request: NativeTokenRequest, idTokenObj: AuthToken, accountEntity: AccountEntity, authority: string, reqTimestamp: number): Promise<AuthenticationResult> {\r\n\r\n        // Add Native Broker fields to Telemetry\r\n        const mats = this.addTelemetryFromNativeResponse(response);\r\n\r\n        // If scopes not returned in server response, use request scopes\r\n        const responseScopes = response.scope ? ScopeSet.fromString(response.scope) : ScopeSet.fromString(request.scope);\r\n\r\n        const accountProperties = response.account.properties || {};\r\n        const uid = accountProperties[\"UID\"] || idTokenObj.claims.oid || idTokenObj.claims.sub || Constants.EMPTY_STRING;\r\n        const tid = accountProperties[\"TenantId\"] || idTokenObj.claims.tid || Constants.EMPTY_STRING;\r\n\r\n        // generate PoP token as needed\r\n        const responseAccessToken = await this.generatePopAccessToken(response, request);\r\n        const tokenType = (request.tokenType === AuthenticationScheme.POP) ? AuthenticationScheme.POP : AuthenticationScheme.BEARER;\r\n\r\n        const result: AuthenticationResult = {\r\n            authority: authority,\r\n            uniqueId: uid,\r\n            tenantId: tid,\r\n            scopes: responseScopes.asArray(),\r\n            account: accountEntity.getAccountInfo(),\r\n            idToken: response.id_token,\r\n            idTokenClaims: idTokenObj.claims,\r\n            accessToken: responseAccessToken,\r\n            fromCache: mats ? this.isResponseFromCache(mats) : false,\r\n            expiresOn: new Date(Number(reqTimestamp + response.expires_in) * 1000),\r\n            tokenType: tokenType,\r\n            correlationId: this.correlationId,\r\n            state: response.state,\r\n            fromNativeBroker: true\r\n        };\r\n\r\n        return result;\r\n    }\r\n\r\n    /**\r\n     * cache the account entity in browser storage\r\n     * @param accountEntity \r\n     */\r\n    cacheAccount(accountEntity: AccountEntity): void{\r\n        // Store the account info and hence `nativeAccountId` in browser cache\r\n        this.browserStorage.setAccount(accountEntity);\r\n\r\n        // Remove any existing cached tokens for this account in browser storage\r\n        this.browserStorage.removeAccountContext(accountEntity).catch((e) => {\r\n            this.logger.error(`Error occurred while removing account context from browser storage. ${e}`);\r\n        });\r\n    }\r\n\r\n    /**\r\n     * Stores the access_token and id_token in inmemory storage\r\n     * @param response \r\n     * @param request \r\n     * @param homeAccountIdentifier \r\n     * @param idTokenObj \r\n     * @param responseAccessToken \r\n     * @param tenantId \r\n     * @param reqTimestamp \r\n     */\r\n    cacheNativeTokens(response: NativeResponse, request: NativeTokenRequest, homeAccountIdentifier: string, idTokenObj: AuthToken, responseAccessToken: string, tenantId: string, reqTimestamp: number): void {\r\n\r\n        // cache idToken in inmemory storage\r\n        const idTokenEntity = IdTokenEntity.createIdTokenEntity(\r\n            homeAccountIdentifier,\r\n            request.authority,\r\n            response.id_token || Constants.EMPTY_STRING,\r\n            request.clientId,\r\n            idTokenObj.claims.tid || Constants.EMPTY_STRING,\r\n        );\r\n        this.nativeStorageManager.setIdTokenCredential(idTokenEntity);\r\n\r\n        // cache accessToken in inmemory storage\r\n        const expiresIn: number = (request.tokenType === AuthenticationScheme.POP)\r\n            ? Constants.SHR_NONCE_VALIDITY\r\n            : (\r\n                typeof response.expires_in === \"string\"\r\n                    ? parseInt(response.expires_in, 10)\r\n                    : response.expires_in\r\n            ) || 0;\r\n        const tokenExpirationSeconds = reqTimestamp + expiresIn;\r\n        const responseScopes = this.generateScopes(response, request);\r\n        const accessTokenEntity = AccessTokenEntity.createAccessTokenEntity(\r\n            homeAccountIdentifier,\r\n            request.authority,\r\n            responseAccessToken,\r\n            request.clientId,\r\n            tenantId,\r\n            responseScopes.printScopes(),\r\n            tokenExpirationSeconds,\r\n            0,\r\n            this.browserCrypto\r\n        );\r\n        this.nativeStorageManager.setAccessTokenCredential(accessTokenEntity);\r\n    }\r\n\r\n    protected addTelemetryFromNativeResponse(response: NativeResponse): MATS | null {\r\n\r\n        const mats = this.getMATSFromResponse(response);\r\n\r\n        if (!mats){\r\n            return null;\r\n        }\r\n        \r\n        this.performanceClient.addStaticFields({\r\n            extensionId: this.nativeMessageHandler.getExtensionId(),\r\n            extensionVersion: this.nativeMessageHandler.getExtensionVersion(),\r\n            matsBrokerVersion: mats.broker_version,\r\n            matsAccountJoinOnStart: mats.account_join_on_start,\r\n            matsAccountJoinOnEnd: mats.account_join_on_end,\r\n            matsDeviceJoin: mats.device_join,\r\n            matsPromptBehavior: mats.prompt_behavior,\r\n            matsApiErrorCode: mats.api_error_code,\r\n            matsUiVisible: mats.ui_visible,\r\n            matsSilentCode: mats.silent_code,\r\n            matsSilentBiSubCode: mats.silent_bi_sub_code,\r\n            matsSilentMessage: mats.silent_message,\r\n            matsSilentStatus: mats.silent_status,\r\n            matsHttpStatus: mats.http_status,\r\n            matsHttpEventCount: mats.http_event_count\r\n        }, this.correlationId);\r\n\r\n        return mats;\r\n    }\r\n\r\n    /**\r\n     * Validates native platform response before processing\r\n     * @param response\r\n     */\r\n    private validateNativeResponse(response: object): NativeResponse {\r\n        if (\r\n            response.hasOwnProperty(\"access_token\") &&\r\n            response.hasOwnProperty(\"id_token\") &&\r\n            response.hasOwnProperty(\"client_info\") &&\r\n            response.hasOwnProperty(\"account\") &&\r\n            response.hasOwnProperty(\"scope\") &&\r\n            response.hasOwnProperty(\"expires_in\")\r\n        ) {\r\n            return response as NativeResponse;\r\n        } else {\r\n            throw NativeAuthError.createUnexpectedError(\"Response missing expected properties.\");\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Gets MATS telemetry from native response\r\n     * @param response\r\n     * @returns\r\n     */\r\n    private getMATSFromResponse(response: NativeResponse): MATS|null {\r\n        if (response.properties.MATS) {\r\n            try {\r\n                return JSON.parse(response.properties.MATS);\r\n            } catch (e) {\r\n                this.logger.error(\"NativeInteractionClient - Error parsing MATS telemetry, returning null instead\");\r\n            }\r\n        }\r\n\r\n        return null;\r\n    }\r\n\r\n    /**\r\n     * Returns whether or not response came from native cache\r\n     * @param response\r\n     * @returns\r\n     */\r\n    protected isResponseFromCache(mats: MATS): boolean {\r\n        if (typeof mats.is_cached === \"undefined\") {\r\n            this.logger.verbose(\"NativeInteractionClient - MATS telemetry does not contain field indicating if response was served from cache. Returning false.\");\r\n            return false;\r\n        }\r\n\r\n        return !!mats.is_cached;\r\n    }\r\n\r\n    /**\r\n     * Translates developer provided request object into NativeRequest object\r\n     * @param request\r\n     */\r\n    protected async initializeNativeRequest(request: PopupRequest|SsoSilentRequest): Promise<NativeTokenRequest> {\r\n        this.logger.trace(\"NativeInteractionClient - initializeNativeRequest called\");\r\n\r\n        const authority = request.authority || this.config.auth.authority;\r\n        const canonicalAuthority = new UrlString(authority);\r\n        canonicalAuthority.validateAsUri();\r\n\r\n        // scopes are expected to be received by the native broker as \"scope\" and will be added to the request below. Other properties that should be dropped from the request to the native broker can be included in the object destructuring here.\r\n        const { scopes, ...remainingProperties } = request; \r\n        const scopeSet = new ScopeSet(scopes || []);\r\n        scopeSet.appendScopes(OIDC_DEFAULT_SCOPES);\r\n\r\n        const getPrompt = () => {\r\n            // If request is silent, prompt is always none\r\n            switch (this.apiId) {\r\n                case ApiId.ssoSilent:\r\n                case ApiId.acquireTokenSilent_silentFlow:\r\n                    this.logger.trace(\"initializeNativeRequest: silent request sets prompt to none\");\r\n                    return PromptValue.NONE;\r\n                default:\r\n                    break;\r\n            }\r\n\r\n            // Prompt not provided, request may proceed and native broker decides if it needs to prompt\r\n            if (!request.prompt) {\r\n                this.logger.trace(\"initializeNativeRequest: prompt was not provided\");\r\n                return undefined;\r\n            }\r\n\r\n            // If request is interactive, check if prompt provided is allowed to go directly to native broker\r\n            switch (request.prompt) {\r\n                case PromptValue.NONE:\r\n                case PromptValue.CONSENT:\r\n                case PromptValue.LOGIN:\r\n                    this.logger.trace(\"initializeNativeRequest: prompt is compatible with native flow\");\r\n                    return request.prompt;\r\n                default:\r\n                    this.logger.trace(`initializeNativeRequest: prompt = ${request.prompt} is not compatible with native flow`);\r\n                    throw BrowserAuthError.createNativePromptParameterNotSupportedError();\r\n            }\r\n        };\r\n        \r\n        const validatedRequest: NativeTokenRequest = {\r\n            ...remainingProperties,\r\n            accountId: this.accountId,\r\n            clientId: this.config.auth.clientId,\r\n            authority: canonicalAuthority.urlString,\r\n            scope: scopeSet.printScopes(),\r\n            redirectUri: this.getRedirectUri(request.redirectUri),\r\n            prompt: getPrompt(),\r\n            correlationId: this.correlationId,\r\n            tokenType: request.authenticationScheme,\r\n            windowTitleSubstring: document.title,\r\n            extraParameters: {\r\n                ...request.extraQueryParameters,\r\n                ...request.tokenQueryParameters,\r\n                telemetry: NativeConstants.MATS_TELEMETRY\r\n            },\r\n            extendedExpiryToken: false // Make this configurable?\r\n        };\r\n\r\n        if (request.authenticationScheme === AuthenticationScheme.POP) {\r\n\r\n            // add POP request type\r\n            const shrParameters: SignedHttpRequestParameters = {\r\n                resourceRequestUri: request.resourceRequestUri,\r\n                resourceRequestMethod: request.resourceRequestMethod,\r\n                shrClaims: request.shrClaims,\r\n                shrNonce: request.shrNonce\r\n            };\r\n\r\n            const popTokenGenerator = new PopTokenGenerator(this.browserCrypto);\r\n            const reqCnfData = await popTokenGenerator.generateCnf(shrParameters);\r\n\r\n            // to reduce the URL length, it is recommended to send the hash of the req_cnf instead of the whole string\r\n            validatedRequest.reqCnf = reqCnfData.reqCnfHash;\r\n            validatedRequest.keyId = reqCnfData.kid;\r\n        }\r\n\r\n        return validatedRequest;\r\n    }\r\n}\r\n"],"mappings":"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"},"metadata":{},"sourceType":"module"}