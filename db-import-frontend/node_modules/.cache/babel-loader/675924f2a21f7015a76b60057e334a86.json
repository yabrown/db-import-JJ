{"ast":null,"code":"var _createClass = require(\"/Users/aribraun/Desktop/db-import/node_modules/@babel/runtime/helpers/createClass.js\").default;\nvar _classCallCheck = require(\"/Users/aribraun/Desktop/db-import/node_modules/@babel/runtime/helpers/classCallCheck.js\").default;\nvar _inherits = require(\"/Users/aribraun/Desktop/db-import/node_modules/@babel/runtime/helpers/inherits.js\").default;\nvar _createSuper = require(\"/Users/aribraun/Desktop/db-import/node_modules/@babel/runtime/helpers/createSuper.js\").default;\nvar _createForOfIteratorHelper = require(\"/Users/aribraun/Desktop/db-import/node_modules/@babel/runtime/helpers/createForOfIteratorHelper.js\").default;\nvar __create = Object.create;\nvar __defProp = Object.defineProperty;\nvar __getOwnPropDesc = Object.getOwnPropertyDescriptor;\nvar __getOwnPropNames = Object.getOwnPropertyNames;\nvar __getProtoOf = Object.getPrototypeOf;\nvar __hasOwnProp = Object.prototype.hasOwnProperty;\nvar __defNormalProp = function __defNormalProp(obj, key, value) {\n  return key in obj ? __defProp(obj, key, {\n    enumerable: true,\n    configurable: true,\n    writable: true,\n    value: value\n  }) : obj[key] = value;\n};\nvar __markAsModule = function __markAsModule(target) {\n  return __defProp(target, \"__esModule\", {\n    value: true\n  });\n};\nvar __export = function __export(target, all) {\n  __markAsModule(target);\n  for (var name in all) __defProp(target, name, {\n    get: all[name],\n    enumerable: true\n  });\n};\nvar __reExport = function __reExport(target, module2, desc) {\n  if (module2 && typeof module2 === \"object\" || typeof module2 === \"function\") {\n    var _iterator = _createForOfIteratorHelper(__getOwnPropNames(module2)),\n      _step;\n    try {\n      var _loop = function _loop() {\n        var key = _step.value;\n        if (!__hasOwnProp.call(target, key) && key !== \"default\") __defProp(target, key, {\n          get: function get() {\n            return module2[key];\n          },\n          enumerable: !(desc = __getOwnPropDesc(module2, key)) || desc.enumerable\n        });\n      };\n      for (_iterator.s(); !(_step = _iterator.n()).done;) {\n        _loop();\n      }\n    } catch (err) {\n      _iterator.e(err);\n    } finally {\n      _iterator.f();\n    }\n  }\n  return target;\n};\nvar __toModule = function __toModule(module2) {\n  return __reExport(__markAsModule(__defProp(module2 != null ? __create(__getProtoOf(module2)) : {}, \"default\", module2 && module2.__esModule && \"default\" in module2 ? {\n    get: function get() {\n      return module2.default;\n    },\n    enumerable: true\n  } : {\n    value: module2,\n    enumerable: true\n  })), module2);\n};\nvar __publicField = function __publicField(obj, key, value) {\n  __defNormalProp(obj, typeof key !== \"symbol\" ? key + \"\" : key, value);\n  return value;\n};\n__export(exports, {\n  AsyncQueueError: function AsyncQueueError() {\n    return _AsyncQueueError;\n  },\n  default: function _default() {\n    return async_queue_default;\n  }\n});\nvar import_base_error = __toModule(require(\"../../errors/base-error\"));\nvar import_connection_error = __toModule(require(\"../../errors/connection-error\"));\nvar _AsyncQueueError = /*#__PURE__*/function (_import_base_error$de) {\n  \"use strict\";\n\n  _inherits(_AsyncQueueError, _import_base_error$de);\n  var _super = _createSuper(_AsyncQueueError);\n  function _AsyncQueueError(message) {\n    var _this;\n    _classCallCheck(this, _AsyncQueueError);\n    _this = _super.call(this, message);\n    _this.name = \"SequelizeAsyncQueueError\";\n    return _this;\n  }\n  return _createClass(_AsyncQueueError);\n}(import_base_error.default);\nvar AsyncQueue = /*#__PURE__*/function () {\n  \"use strict\";\n\n  function AsyncQueue() {\n    _classCallCheck(this, AsyncQueue);\n    __publicField(this, \"previous\");\n    __publicField(this, \"closed\");\n    __publicField(this, \"rejectCurrent\");\n    this.previous = Promise.resolve();\n    this.closed = false;\n    this.rejectCurrent = function () {};\n  }\n  _createClass(AsyncQueue, [{\n    key: \"close\",\n    value: function close() {\n      this.closed = true;\n      this.rejectCurrent(new import_connection_error.default(new _AsyncQueueError(\"the connection was closed before this query could finish executing\")));\n    }\n  }, {\n    key: \"enqueue\",\n    value: function enqueue(asyncFunction) {\n      var _this2 = this;\n      return new Promise(function (resolve, reject) {\n        _this2.previous = _this2.previous.then(function () {\n          _this2.rejectCurrent = reject;\n          if (_this2.closed) {\n            return reject(new import_connection_error.default(new _AsyncQueueError(\"the connection was closed before this query could be executed\")));\n          }\n          return asyncFunction().then(resolve, reject);\n        });\n      });\n    }\n  }]);\n  return AsyncQueue;\n}();\nvar async_queue_default = AsyncQueue;","map":{"version":3,"names":["__export","exports","AsyncQueueError","default","_default","async_queue_default","import_base_error","__toModule","require","import_connection_error","_import_base_error$de","_inherits","_AsyncQueueError","_super","_createSuper","message","_this","_classCallCheck","call","name","_createClass","AsyncQueue","__publicField","previous","Promise","resolve","closed","rejectCurrent","key","value","close","enqueue","asyncFunction","_this2","reject","then"],"sources":["../../../src/dialects/mssql/async-queue.ts"],"sourcesContent":["import BaseError from '../../errors/base-error';\nimport ConnectionError from '../../errors/connection-error';\n\n/**\n * Thrown when a connection to a database is closed while an operation is in progress\n */\nexport class AsyncQueueError extends BaseError {\n  constructor(message: string) {\n    super(message);\n    this.name = 'SequelizeAsyncQueueError';\n  }\n}\n\nclass AsyncQueue {\n  previous: Promise<unknown>;\n  closed: boolean;\n  rejectCurrent: (reason?: any) => void;\n\n  constructor() {\n    this.previous = Promise.resolve();\n    this.closed = false;\n    this.rejectCurrent = () => {\n      /** do nothing */\n    };\n  }\n\n  close() {\n    this.closed = true;\n    this.rejectCurrent(\n      new ConnectionError(\n        new AsyncQueueError(\n          'the connection was closed before this query could finish executing'\n        )\n      )\n    );\n  }\n\n  enqueue(asyncFunction: (...args: any[]) => Promise<unknown>) {\n    // This outer promise might seems superflous since down below we return asyncFunction().then(resolve, reject).\n    // However, this ensures that this.previous will never be a rejected promise so the queue will\n    // always keep going, while still communicating rejection from asyncFunction to the user.\n    return new Promise((resolve, reject) => {\n      this.previous = this.previous.then(() => {\n        this.rejectCurrent = reject;\n        if (this.closed) {\n          return reject(\n            new ConnectionError(\n              new AsyncQueueError(\n                'the connection was closed before this query could be executed'\n              )\n            )\n          );\n        }\n        return asyncFunction().then(resolve, reject);\n      });\n    });\n  }\n}\n\nexport default AsyncQueue;\n"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAAAA,QAAA,CAAAC,OAAA;EAAAC,eAAA,WAAAA,gBAAA;IAAA,OAAAA,gBAAA;EAAA;EAAAC,OAAA,WAAAC,SAAA;IAAA,OAAAC,mBAAA;EAAA;AAAA;AAAA,IAAAC,iBAAA,GAAsBC,UAAA,CAAAC,OAAA;AACtB,IAAAC,uBAAA,GAA4BF,UAAA,CAAAC,OAAA;AAAA,IAKrBN,gBAAA,0BAAAQ,qBAAA;EAAA;;EAAAC,SAAA,CAAAC,gBAAA,EAAAF,qBAAA;EAAA,IAAAG,MAAA,GAAAC,YAAA,CAAAF,gBAAA;EACL,SAAAA,iBAAYG,OAAA,EAAiB;IAAA,IAAAC,KAAA;IAAAC,eAAA,OAAAL,gBAAA;IAC3BI,KAAA,GAAAH,MAAA,CAAAK,IAAA,OAAMH,OAAA;IACNC,KAAA,CAAKG,IAAA,GAAO;IAAA,OAAAH,KAAA;EAAA;EAAA,OAAAI,YAAA,CAAAR,gBAAA;AAAA,EAHqBN,iBAAA,CAAAH,OAAA;AAAA,IAOrCkB,UAAA;EAAA;;EAKE,SAAAA,WAAA,EAAc;IAAAJ,eAAA,OAAAI,UAAA;IAJdC,aAAA;IACAA,aAAA;IACAA,aAAA;IAGE,KAAKC,QAAA,GAAWC,OAAA,CAAQC,OAAA;IACxB,KAAKC,MAAA,GAAS;IACd,KAAKC,aAAA,GAAgB,YAAM;EAAA;EAAAP,YAAA,CAAAC,UAAA;IAAAO,GAAA;IAAAC,KAAA,EAK7B,SAAAC,MAAA,EAAQ;MACN,KAAKJ,MAAA,GAAS;MACd,KAAKC,aAAA,CACH,IAAIlB,uBAAA,CAAAN,OAAA,CACF,IAAID,gBAAA,CACF;IAAA;EAAA;IAAA0B,GAAA;IAAAC,KAAA,EAMR,SAAAE,QAAQC,aAAA,EAAqD;MAAA,IAAAC,MAAA;MAI3D,OAAO,IAAIT,OAAA,CAAQ,UAACC,OAAA,EAASS,MAAA,EAAW;QACtCD,MAAA,CAAKV,QAAA,GAAWU,MAAA,CAAKV,QAAA,CAASY,IAAA,CAAK,YAAM;UACvCF,MAAA,CAAKN,aAAA,GAAgBO,MAAA;UACrB,IAAID,MAAA,CAAKP,MAAA,EAAQ;YACf,OAAOQ,MAAA,CACL,IAAIzB,uBAAA,CAAAN,OAAA,CACF,IAAID,gBAAA,CACF;UAAA;UAKR,OAAO8B,aAAA,GAAgBG,IAAA,CAAKV,OAAA,EAASS,MAAA;QAAA;MAAA;IAAA;EAAA;EAAA,OAAAb,UAAA;AAAA;AAM7C,IAAOhB,mBAAA,GAAQgB,UAAA"},"metadata":{},"sourceType":"script"}